#!/bin/bash

changes=0

# Ensure we have a config file with the fixed options
if [ ! -e "$SNAP_DATA/miral-kiosk.config" ]; then
cat <<EOT > "$SNAP_DATA/miral-kiosk.config"
arw-file=
file=/run/mir_socket
console-provider=vt
EOT
let changes+=1
fi

# display-config
display_config=$(snapctl get display-config)
if [ -n "${display_config}" ]; then
  echo "# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN" > "$SNAP_DATA/miral-kiosk.display~"
  echo "# USE 'snap set mir-kiosk display-config=...' INSTEAD"              >> "$SNAP_DATA/miral-kiosk.display~"
  echo ""                                                                   >> "$SNAP_DATA/miral-kiosk.display~"
  echo "${display_config}"                                                  >> "$SNAP_DATA/miral-kiosk.display~"
  if ! diff "$SNAP_DATA/miral-kiosk.display~" "$SNAP_DATA/miral-kiosk.display" > /dev/null; then
    mv "$SNAP_DATA/miral-kiosk.display"  "$SNAP_DATA/miral-kiosk.display.save"
    mv "$SNAP_DATA/miral-kiosk.display~" "$SNAP_DATA/miral-kiosk.display"
    let changes+=1
  else
    rm "$SNAP_DATA/miral-kiosk.display~"
  fi
fi

# display-layout
display_layout=$(snapctl get display-layout)
if [ -n "${display_layout}" ]; then
  if [ -e "$SNAP_DATA/miral-kiosk.display" ]; then
    if [ -z "$(grep "^  ${display_layout}:" "$SNAP_DATA/miral-kiosk.display")" ]; then
      echo "ERROR: '$display_layout' is not a layout in $SNAP_DATA/miral-kiosk.display"
      exit 1
    fi
  else
    if [ "${display_layout}" != "default" ]; then
      echo "ERROR: '$display_layout' is not a layout in $SNAP_DATA/miral-kiosk.display"
      exit 1
    fi
  fi

  if [ "display-layout=${display_layout}" != "$(grep \^display-layout= $SNAP_DATA/miral-kiosk.config)" ]; then
    if [ changes -gt 0 ]; then
      sed '/^display-layout=/d' $SNAP_DATA/miral-kiosk.config
    else
      sed --in-place=.save '/^display-layout=/d' $SNAP_DATA/miral-kiosk.config
    fi
    echo display-layout=${display_layout} >> $SNAP_DATA/miral-kiosk.config
    let changes+=1
  fi
fi

# vt
vt=$(snapctl get vt)
if [ -n "${vt}" ]; then
  if [ -n "${vt//[0-9]}" ] || [ ! -e "/dev/tty$vt" ]; then
    echo "ERROR: '$vt' is not a valid VT"
    exit 1
  fi

  if [ "vt=${vt}" != "$(grep vt= $SNAP_DATA/miral-kiosk.config)" ]; then
    if [ changes -gt 0 ]; then
      sed '/^vt/d' $SNAP_DATA/miral-kiosk.config
    else
      sed --in-place=.save '/^vt/d' $SNAP_DATA/miral-kiosk.config
    fi
    echo vt=${vt} >> $SNAP_DATA/miral-kiosk.config
    let changes+=1
  fi
fi

if [ $changes -gt 0 ]; then
  snapctl restart $SNAP_NAME
fi